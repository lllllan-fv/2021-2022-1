# 用户相关

- 用户：登录系统的一个账号，是购买车票的主体。

- 乘客：真实存在的一个个体，是乘坐火车的主体。



#### <span id="users">用户信息表 users</span>

|  字段名称   |  字段类型   | 是否主键 | 是否外键 | 是否为空 | 字段含义 |          备注          |
| :---------: | :---------: | :------: | :------: | :------: | :------: | :--------------------: |
|   **id**    |     int     |    是    |          |          | 用户编码 |                        |
|    name     | varchar(10) |          |          |          | 用户昵称 |                        |
|    type     |   tinyint   |          |          |          | 用户类型 |    0-用户, 1-管理员    |
|  telephone  | varchar(11) |          |          |          | 联系方式 |                        |
|  password   | varchar(20) |          |          |          | 用户密码 |                        |
|    state    |   tinyint   |          |          |          | 用户状态 | 0-正常, 1-冻结, 2-注销 |
| create_time |    date     |          |          |          | 创建时间 |       yyyy-mm-dd       |

```sql
CREATE TABLE users (
	`id` INT UNSIGNED AUTO_INCREMENT,
	`name` VARCHAR(10) NOT NULL,
	`type` tinyint NOT NULL COMMENT '0-用户, 1-管理员',
	`telephone` VARCHAR(11) NOT NULL,
	`password` VARCHAR(20) NOT NULL,
	`state` tinyint NOT NULL COMMENT '0-正常, 1-冻结, 2-注销',
	`create_time` DATE NOT NULL,
	PRIMARY KEY (`id`)
) ENGINE = InnoDB CHARSET = utf8;
```

```sql
insert users VALUES(null, "test01", 0, "12345678911", "admin", 0, NOW());
```



#### <span id="passengers">乘客信息表 passengers</span>

| 字段名称  |  字段类型   | 是否主键 | 是否外键 | 是否为空 | 字段含义 |                             备注                             |
| :-------: | :---------: | :------: | :------: | :------: | :------: | :----------------------------------------------------------: |
|  **id**   |     int     |    是    |          |          | 乘客编码 |                                                              |
|   name    | varchar(20) |          |          |          | 乘客姓名 |                                                              |
| telephone | varchar(11) |          |          |          | 联系方式 |                                                              |
|  ID_type  | varchar(15) |          |          |          | 证件类型 | 中华人民共和国居民身份证<br>港澳居民来往内地通行证<br>台湾居民来往大陆通行证 |
|   ID_no   | varchar(30) |          |          |          | 证件号码 |                                                              |
|   type    |   tinyint   |          |          |          | 乘客类型 |            0-成人, 1-学生, <br>2-儿童, 3-残疾军人            |

```sql
CREATE TABLE passengers (
	`id` INT UNSIGNED AUTO_INCREMENT,
	`name` VARCHAR(10) NOT NULL,
	`telephone` VARCHAR(11) NOT NULL,
	`ID_type` VARCHAR(15) NOT NULL,
	`ID_no` VARCHAR(30) NOT NULL,
	`type` TINYINT NOT NULL COMMENT '0-成人, 1-学生, 2-儿童, 3-残疾军人',
	PRIMARY KEY (`id`)
) ENGINE = InnoDB CHARSET = utf8;
```

```sql
INSERT passengers VALUES(NULL, "苏桐渤", "12345678911", "中华人民共和国居民身份证", "1234***********789", "1");
```



# 车站相关



#### <span id="provinces">省份编码表 provinces</span>

| 字段名称 |  字段类型   | 是否主键 | 是否外键 | 是否为空 | 字段含义 | 备注 |
| :------: | :---------: | :------: | :------: | :------: | :------: | :--: |
|  **id**  |     int     |    是    |          |          | 省份编码 |      |
|   name   | varchar(10) |          |          |          | 省份名称 |      |

```sql
CREATE TABLE provinces(
    `id` INT UNSIGNED AUTO_INCREMENT, 
    `name` VARCHAR(10) NOT NULL,
    PRIMARY KEY ( `id` )
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

```sql
INSERT provinces VALUES(NULL, "浙江省");
```



#### <span id="cities">城市编码表 cities</span>

|   字段名称    |  字段类型   | 是否主键 |         是否外键         | 是否为空 |   字段含义   | 备注 |
| :-----------: | :---------: | :------: | :----------------------: | :------: | :----------: | :--: |
|    **id**     |     int     |    是    |                          |          |   城市编码   |      |
| *province_id* |     int     |          | [省份编码表](#provinces) |          | 所在省份编码 |      |
|     name      | varchar(20) |          |                          |          |   城市名称   |      |

```sql
CREATE TABLE cities(
    `id` INT UNSIGNED AUTO_INCREMENT, 
    `province_id` INT UNSIGNED NOT NULL,
    `name` VARCHAR(20) NOT NULL,	
    PRIMARY KEY ( `id` ),
    FOREIGN KEY ( `province_id` ) REFERENCES provinces( `id` ) 
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

```sql
INSERT cities VALUES(NULL, 1, "杭州市"); 
```

```sql
SELECT ct.id AS id, pv.name AS province, ct.name AS city
FROM provinces pv, cities ct
WHERE pv.id = ct.province_id
ORDER BY province;
```



#### <span id="stations">火车站编码表 stations</span>

|   字段名称   |  字段类型   | 是否主键 |       是否外键        | 是否为空 |   字段含义   | 备注 |
| :----------: | :---------: | :------: | :-------------------: | :------: | :----------: | :--: |
|    **id**    |     int     |    是    |                       |          |  火车站编码  |      |
|  *city_id*   |     int     |          | [城市编码表](#cities) |          | 所在城市编码 |      |
| station_name | varchar(20) |          |                       |          |  火车站名称  |      |

```sql
CREATE TABLE stations(
    `id` INT UNSIGNED AUTO_INCREMENT, 
    `city_id` INT UNSIGNED NOT NULL,
    `name` VARCHAR(20) NOT NULL,	
    PRIMARY KEY ( `id` ),
    FOREIGN KEY ( `city_id` ) REFERENCES cities( `id` ) 
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

```sql
INSERT stations VALUES(null, 1, "杭州东站");
```

```sql
CREATE VIEW view_stations
AS(
	SELECT st.id AS id,
        pv.name AS povince,
        ct.name AS city,
        st.name AS station
    FROM provinces pv,
        cities ct,
        stations st
    WHERE  pv.id = ct.province_id
    	AND ct.id = st.city_id
    ORDER  BY province, 
    	city
);
```



# 火车相关

- 火车信息表-火车：实指一列火车实体。 
- 火车运行时刻表：指该列火车在某天运行的具体行为。



#### <span id="trains">火车信息表 trains</span>

- 表中的出发时间，规定的是每次发车的固定时间，因此不存在具体日期。
- 同时可能存在次日达的情况，到达日期和出发日期不在同一天，为记录方便，表中记录的是列车的运行时长，而非到达时间。

|       字段名称        |  字段类型   | 是否主键 |         是否外键          | 是否为空 |  字段含义  |                             备注                             |
| :-------------------: | :---------: | :------: | :-----------------------: | :------: | :--------: | :----------------------------------------------------------: |
|        **id**         |     int     |    是    |                           |          |  火车编码  |                                                              |
|         name          | varchar(10) |          |                           |          |  火车名称  |                          eg: G1818                           |
|         type          |     int     |          |                           |          |  火车类型  | 0-普通旅客列车<br>1-普通动车组列车<br>2-高速动车组列车<br>3-其他 |
|  *departure_station*  |     int     |          | [火车站编码表](#stations) |          | 起始站编码 |                   首程起始站<br>返程目的站                   |
| *destination_station* |     int     |          | [火车站编码表](#stations) |          | 目的站编码 |                   首程目的站<br>返程起始站                   |
|    departure_time     |    time     |          |                           |          |  出发时间  |                                                              |
|       last_time       |    time     |          |                           |          |  运行时长  |                                                              |


```sql
CREATE TABLE trains (
	`id` INT UNSIGNED AUTO_INCREMENT,
	`name` VARCHAR(10) NOT NULL,
	`type` tinyint NOT NULL COMMENT '0-普通旅客列车, 1-普通动车组列车, 2-高速动车组列车, 3-其他',
	`departure_station` int UNSIGNED NOT NULL,
	`destination_station` int UNSIGNED NOT NULL,
	`departure_time` time NOT NULL,
	`last_time` time NOT NULL,
	PRIMARY KEY (`id`),
	FOREIGN KEY (`departure_station`) REFERENCES stations (`id`),
	FOREIGN KEY (`destination_station`) REFERENCES stations (`id`)
) ENGINE = InnoDB CHARSET = utf8;
```

```sql
insert trains values(null, 'G7659', 1, 1, 5, '06:33:00', '18:00');
```

```sql
CREATE VIEW view_trains
AS (
    SELECT trains.id          id,
        trains.name           name,
        trains.type           type,
        dep.name              departure_station,
        des.name              destination_station,
        trains.departure_time departure_time,
        trains.last_time      last_time
    FROM trains,
        stations des,
        stations dep
    WHERE  trains.departure_station = dep.id
          AND trains.destination_station = des.id
);
```



#### <span id="runnings">火车运行表 runnings</span>

|       字段名称        | 字段类型 | 是否主键 |       是否外键        | 是否为空 |   字段含义   |           备注           |
| :-------------------: | :------: | :------: | :-------------------: | :------: | :----------: | :----------------------: |
|        **id**         |   int    |    是    |                       |          | 火车运行编码 |                          |
|      *train_id*       |   int    |          | [火车信息表](#trains) |          |   火车编码   |                          |
|    departure_date     |   date   |          |                       |          |   发车日期   |                          |
| actual_departure_time | datetime |          |                       |    是    | 实际发车时间 | 可为空，为空时表示未发车 |
|  actual_arrive_time   | datetime |          |                       |    是    | 实际到达时间 | 课为空，为空时表示未到达 |
|        cancel         | tinyint  |          |                       |          |   是否取消   |          01表示          |

```sql
CREATE TABLE runnings (
	`id` INT UNSIGNED AUTO_INCREMENT,
	`train_id` int UNSIGNED NOT NULL,
	`departure_date` date NOT NULL,
	`actual_departure_time` datetime,
	`actual_arrive_time` datetime,
	`cancel` tinyint NOT NULL COMMENT '0-正常, `1-取消`',
	PRIMARY KEY (`id`),
	FOREIGN KEY (`train_id`) REFERENCES trains (`id`)
) ENGINE = InnoDB CHARSET = utf8;
```

```sql
INSERT runnings VALUES (NULL, 1, '2021-12-21', NULL, NULL, 0);
```

```sql
CREATE VIEW view_runnings
AS (
    SELECT runnings.id id,
           trains.id train_id,
           trains.name name,
           trains.type type,
           trains.departure_station,
           trains.destination_station,
           Concat(runnings.departure_date, ' ', trains.departure_time) departure_datetime,
           Addtime(Concat(runnings.departure_date, ' ', trains.departure_time), trains.last_time) arrive_time,
           runnings.actual_departure_time,
           runnings.actual_arrive_time,
           runnings.cancel
    FROM   view_trains trains,
           runnings
    WHERE  trains.id = runnings.train_id
);
```



# 车厢座位相关

注：【车厢信息表】【座位模板】是每列火车拥有的固定的信息，无论哪次运行，都应该遵守的。座位信息表则是某列火车某一次具体运行中的每一个座位的信息。



#### <span id="cabins">车厢信息表 cabins</span>

注：每次发车的车厢信息规范模板

|   字段名称   | 字段类型 | 是否主键 |       是否外键        | 是否为空 | 字段含义 |                             备注                             |
| :----------: | :------: | :------: | :-------------------: | :------: | :------: | :----------------------------------------------------------: |
| **cabin_id** |   int    |    是    |                       |          | 车厢编码 |                                                              |
|  *train_id*  |   int    |          | [火车信息表](#trains) |          | 火车编码 |                                                              |
|  cabin_type  |   int    |          |                       |          | 车厢类型 | 一等座车厢 \| 硬座车厢 \| 等<br>规定了该车厢内的所有座位类型 |
| cabin_number |   int    |          |                       |          |  车厢号  |                                                              |



#### <span id="seat_template">座位模板 seat_template</span>

|       字段名称       |  字段类型  | 是否主键 |       是否外键        | 是否为空 |   字段含义   |   备注    |
| :------------------: | :--------: | :------: | :-------------------: | :------: | :----------: | :-------: |
| **seat_template_id** |    int     |    是    |                       |          | 座位模板编码 |           |
|      *cabin_id*      |    int     |          | [车厢信息表](#cabins) |          |   车厢编码   |           |
|    seat_position     | varchar(5) |          |                       |          |    座位号    | eg: 16排A |
|      adult_fare      |   float    |          |                       |          |   成人票价   |           |
|     student_fare     |   float    |          |                       |          |   学生票价   |           |
|      child_fare      |   float    |          |                       |          |   儿童票价   |           |



#### <span id="seats">座位信息表 seats</span>

|      字段名称      | 字段类型 | 是否主键 |          是否外键          | 是否为空 |   字段含义   | 备注 |
| :----------------: | :------: | :------: | :------------------------: | :------: | :----------: | :--: |
|    **seat_id**     |   int    |    是    |                            |          |   座位编码   |      |
| *train_running_id* |   int    |          |  [火车运行表](#runnings)   |          |   火车编码   |      |
| *seat_template_id* |   int    |          | [座位模板](#seat_template) |          | 座位模板编码 |      |



# 订单相关



#### <span id="orders">订单信息表 orders</span>

|   字段名称   | 字段类型 | 是否主键 |       是否外键       | 是否为空 |      字段含义      | 备注 |
| :----------: | :------: | :------: | :------------------: | :------: | :----------------: | :--: |
| **order_id** |   int    |    是    |                      |          |      订单编码      |      |
|  *user_id*   |   int    |          | [用户信息表](#users) |          | 购票人（用户）编号 |      |
| create_time  | datetime |          |                      |          |    订单创建时间    |      |
|   has_paid   |   int    |          |                      |          |    是否已经付款    |      |



！！订单是一起取消的

！！可单独改签和退票

#### <span id="order_details">订单详细 order_details</span>

注：考虑到一次订单可能为多个人一起买票，但是订单的改签和取消，可能发生在整个订单或个别乘客身上。
		所以改签和取消的状态绑定到了订单详细上。

|       字段名称       | 字段类型 | 是否主键 |         是否外键          | 是否为空 |     字段含义     |           备注           |
| :------------------: | :------: | :------: | :-----------------------: | :------: | :--------------: | :----------------------: |
|    **detail_id**     |   int    |    是    |                           |          |   订单详细编码   |                          |
|      *order_id*      |   int    |    是    |   [订单信息表](#orders)   |          |     订单编码     |                          |
|    *passenger_id*    |   int    |          | [乘客信息表](#passengers) |          |     乘客编码     |                          |
|      *seat_id*       |   int    |          |   [座位信息表](#seats)    |          |     座位编码     |                          |
| *previous_detail_id* |   int    |          | [订单详细](order_details) |    是    | 改签前的订单详细 | 空值表示普通订单，非改签 |
|       canceled       |   int    |          |                           |          |    是否已取消    |                          |

